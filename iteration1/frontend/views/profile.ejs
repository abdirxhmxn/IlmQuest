<%
// ==============================
// IlmQuest Profile (World-class, CSP-friendly, responsive)
// - No inline onclick handlers (better with CSP/helmet)
// - Dialog uses <dialog> with JS fallback
// - Lucide icons gracefully degrade if blocked by CSP
// - Defensive rendering (won’t crash if some fields missing)
// - Accessible labels + keyboard friendly
// ==============================

const role = (user && user.role) ? String(user.role) : "guest";
const fullName = `${user?.firstName || ""} ${user?.lastName || ""}`.trim() || "Profile";
const username = user?.userName ? String(user.userName) : "";
const email = user?.email ? String(user.email) : "N/A";

function formatDate(value) {
  try {
    if (!value) return "N/A";
    return new Date(value).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
  } catch (e) {
    return "N/A";
  }
}

const avatarSrc =
  user?.profilePic ||
  "https://st3.depositphotos.com/15648834/17930/v/600/depositphotos_179308454-stock-illustration-unknown-person-silhouette-glasses-profile.jpg";

let dashboardPath = "/student/home";
if (role === "admin") dashboardPath = "/admin/home";
if (role === "teacher") dashboardPath = "/teacher/home";
if (role === "parent") dashboardPath = "/parent/home";

function roleLabel(r) {
  const map = { admin: "Administrator", teacher: "Teacher", student: "Student", parent: "Parent" };
  return map[r] || "User";
}

const joinedAt = formatDate(user?.createdAt);
const dob = user?.DOB ? formatDate(user?.DOB) : "Not provided";
%>

<% if (role === "admin") { %>
  <%- include("partials/adminHeader") %>
<% } else if (role === "teacher") { %>
  <%- include("partials/teacherHeader") %>
<% } else { %>
  <%- include("partials/inHeader") %>
<% } %>

<!-- If you use Helmet CSP, consider self-hosting lucide in /public and switching to /js/lucide.js -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<link rel="stylesheet" href="/css/pages/profile.css">

<div class="p-page p-wrap" data-role="<%= role %>">
  <div class="p-container">
    <section class="hero" aria-label="Profile overview">
      <div class="hero-inner">
        <div class="hero-top">
          <div class="avatar" aria-hidden="true">
            <img src="<%= avatarSrc %>" alt="Profile avatar" loading="lazy" />
          </div>

          <div class="hero-meta">
            <h1 class="hero-title"><%= fullName %></h1>

            <p class="hero-sub">
              <% if (username) { %>
                <span class="handle">
                  <i data-lucide="at-sign" class="icon-16"></i>
                  <span>@<%= username %></span>
                </span>
              <% } %>

              <span class="pill" title="Account role">
                <i data-lucide="shield" class="icon-16"></i>
                <span><%= roleLabel(role) %></span>
              </span>
            </p>
          </div>

          <div class="hero-actions" role="group" aria-label="Profile actions">
            <!-- <button type="button" id="openAccountDialogBtn" class="btn btn-ghost">
              <i data-lucide="user-cog" class="icon-pad-right"></i>
              Manage Credentials
            </button> -->

            <!-- <a href="<%= dashboardPath %>" class="btn btn-solid">
              <i data-lucide="layout-dashboard" class="icon-pad-right"></i>
              Dashboard
            </a> -->

            <a href="/logout" class="btn btn-ghost profile-logout-btn">
              <i data-lucide="log-out" class="icon-pad-right"></i>
              Logout
            </a>
          </div>
        </div>
      </div>
    </section>

    <section class="grid" aria-label="Profile details">
      <article class="card">
        <div class="card-head">
          <i data-lucide="user" class="icon-18"></i>
          <h2>Personal Information</h2>
        </div>
        <div class="card-body">
          <div class="kv">
            <div class="row">
              <div class="label">Email</div>
              <div class="value"><%= email %></div>
            </div>

            <div class="row">
              <div class="label">Date of Birth</div>
              <div class="value"><%= dob %></div>
            </div>

            <div class="row">
              <div class="label">Joined</div>
              <div class="value"><%= joinedAt %></div>
            </div>
          </div>
        </div>
      </article>

      <article class="card">
        <div class="card-head">
          <i data-lucide="briefcase" class="icon-18"></i>
          <h2>Role Details</h2>
        </div>
        <div class="card-body">
          <div class="role-box">
            <% if (role === "teacher") { %>
              <h3 class="role-title">Teacher Profile</h3>

              <div class="kv">
                <div class="row">
                  <div class="label">Employee ID</div>
                  <div class="value"><%= user?.teacherInfo?.employeeId || "N/A" %></div>
                </div>
              </div>

              <div class="chips" aria-label="Subjects">
                <% if (user?.teacherInfo?.subjects?.length) { %>
                  <% user.teacherInfo.subjects.forEach(subject => { %>
                    <span class="chip"><%= subject %></span>
                  <% }) %>
                <% } else { %>
                  <span class="chip">No subjects assigned</span>
                <% } %>
              </div>

            <% } else if (role === "student") { %>
              <h3 class="role-title">Student Profile</h3>

              <div class="kv">
                <div class="row">
                  <div class="label">Grade Level</div>
                  <div class="value"><%= user?.studentInfo?.gradeLevel || "N/A" %></div>
                </div>
                <div class="row">
                  <div class="label">Student Number</div>
                  <div class="value"><%= user?.studentInfo?.studentNumber || "N/A" %></div>
                </div>
                <div class="row">
                  <div class="label">Program</div>
                  <div class="value"><%= user?.studentInfo?.programType || "N/A" %></div>
                </div>
              </div>

            <% } else if (role === "parent") { %>
              <h3 class="role-title">Parent Profile</h3>
              <p class="role-parent-text">
                Guardian of <span class="role-parent-count"><%= user?.parentInfo?.children?.length || 0 %></span> student(s)
              </p>

              <div class="chips" aria-label="Children">
                <% if (user?.parentInfo?.children?.length) { %>
                  <% user.parentInfo.children.forEach(child => { %>
                    <span class="chip"><%= child.childName %></span>
                  <% }) %>
                <% } else { %>
                  <span class="chip">No linked children</span>
                <% } %>
              </div>

            <% } else { %>
              <h3 class="role-title">Administrator Profile</h3>
              <div class="role-grid">
                <div class="row">
                  <div class="label">School Scope</div>
                  <div class="value"><%= user?.schoolId || "N/A" %></div>
                </div>
                <div class="row">
                  <div class="label">Privileges</div>
                  <div class="value">Users, Classes, Communication, Reports</div>
                </div>
              </div>
              <div class="chips" aria-label="Admin capabilities">
                <span class="chip">Manage Users</span>
                <span class="chip">Assign Classes</span>
                <span class="chip">Track Performance</span>
                <span class="chip">Audit Updates</span>
              </div>
              <p class="role-note">
                Full school management access is enabled. Use this account for policy-safe updates, enrollment checks, and operational oversight.
              </p>
            <% } %>
          </div>
        </div>
      </article>
<article class="card">
  <div class="card-head">
    <i data-lucide="shield-check" class="icon-18"></i>
    <h2>Account Status</h2>
  </div>

  <div class="card-body">
    <div class="kv">
      <div class="row">
        <div class="label">Sign-in Identifier</div>
        <div class="value">
          <% if (username) { %>
            @<%= username %>
          <% } else { %>
            N/A
          <% } %>
        </div>
      </div>

      <div class="row">
        <div class="label">Helpful Links</div>
        <div class="value inline-flex-wrap">
          <a href="/account/change-username" class="btn btn-outline profile-link-btn">
            <i data-lucide="at-sign" class="icon-18"></i>
            Change Username
          </a>

          <a href="/reset-password" class="btn btn-outline profile-link-btn">
            <i data-lucide="key-round" class="icon-18"></i>
            Change Password
          </a>

          <a href="/forgot-password" class="btn btn-outline profile-link-btn">
            <i data-lucide="life-buoy" class="icon-18"></i>
            Recovery Options
          </a>
        </div>
      </div>
    </div>
  </div>
</article>
<article class="bottom-full">
        <div class="row bottom">
        <div class="label">What’s next</div>
        <div class="value whats-next-text">
          Coming soon: activity log, login alerts, and downloadable account report.
        </div>
      </div>
</article>
<article class="bottom-full">
  <div class="card">
    <div class="card-head">
      <i data-lucide="sparkles" class="icon-18"></i>
      <h2>Quick Guidance</h2>
    </div>
    <div class="card-body">
      <ul class="quick-list">
        <% if (role === "admin") { %>
          <li>Review user enrollments weekly and resolve duplicate profile data early.</li>
          <li>Keep class assignments balanced before publishing schedules.</li>
          <li>Use password reset and username tools only for verified requests.</li>
        <% } else if (role === "teacher") { %>
          <li>Review attendance and grades before the end of each week.</li>
          <li>Keep subject lists current so class dashboards stay accurate.</li>
          <li>Use account recovery options only from trusted devices.</li>
        <% } else if (role === "student") { %>
          <li>Check your program and class details for accuracy each term.</li>
          <li>Track progress weekly and ask teachers about missing scores quickly.</li>
          <li>Update password regularly and keep it private.</li>
        <% } else { %>
          <li>Monitor student activity and communicate changes to school staff quickly.</li>
          <li>Verify linked child profiles are correct.</li>
          <li>Use account recovery tools if login details are lost.</li>
        <% } %>
      </ul>
    </div>
  </div>
</article>
    </section>
  </div>
</div>

<dialog id="accountActionDialog" class="dialog" aria-labelledby="accountActionDialogTitle">
  <div class="dialog-card">
    <div class="dialog-head">
      <h3 id="accountActionDialogTitle">Update Account Credentials</h3>
      <button type="button" id="closeAccountDialogBtn" class="close-btn" aria-label="Close">
        <i data-lucide="x" class="icon-18"></i>
      </button>
    </div>

    <p class="dialog-desc">
      Choose what you want to update.
    </p>

    <div class="dialog-actions">
      <a href="/reset-password?mode=password" class="btn btn-primary center-content">
        <i data-lucide="lock" class="icon-18"></i>
        Change Password
      </a>

      <a href="/reset-password?mode=username" class="btn btn-outline center-content">
        <i data-lucide="at-sign" class="icon-18"></i>
        Change Username
      </a>

      <form method="dialog" class="display-contents">
        <button type="submit" class="btn btn-danger center-content">
          Cancel
        </button>
      </form>
    </div>
  </div>
</dialog>

<script>
  // ---------- Icons (graceful) ----------
  try { if (window.lucide) lucide.createIcons(); } catch (e) {}

  // ---------- Dialog (future-proof + fallback) ----------
  const dialog = document.getElementById("accountActionDialog");
  const openBtn1 = document.getElementById("openAccountDialogBtn");
  const openBtn2 = document.getElementById("openAccountDialogBtn2");
  const closeBtn = document.getElementById("closeAccountDialogBtn");

  const supportsDialog = !!(dialog && dialog.showModal);

  function openDialog() {
    if (!dialog) return;
    if (supportsDialog) {
      if (!dialog.open) dialog.showModal();
      return;
    }
    // Fallback: emulate modal if <dialog> unsupported (rare, but future-proof)
    dialog.setAttribute("open", "");
    dialog.style.display = "block";
  }

  function closeDialog() {
    if (!dialog) return;
    if (supportsDialog) return dialog.close();
    dialog.removeAttribute("open");
    dialog.style.display = "none";
  }

  openBtn1?.addEventListener("click", openDialog);
  openBtn2?.addEventListener("click", openDialog);
  closeBtn?.addEventListener("click", closeDialog);

  // Close on outside click (only when supported, since fallback isn’t a true backdrop)
  dialog?.addEventListener("click", (event) => {
    if (!supportsDialog) return;
    const rect = dialog.getBoundingClientRect();
    const inDialog =
      rect.top <= event.clientY &&
      event.clientY <= rect.top + rect.height &&
      rect.left <= event.clientX &&
      event.clientX <= rect.left + rect.width;

    if (!inDialog) closeDialog();
  });

  // ESC to close fallback mode
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Escape") return;
    if (!dialog) return;
    if (supportsDialog && dialog.open) return; // native handles ESC
    if (dialog.hasAttribute("open")) closeDialog();
  });
</script>

<% if (role === "admin") { %>
  <%- include("partials/adminFooter") %>
<% } else if (role === "teacher") { %>
  <%- include("partials/teacherFooter") %>
<% } else { %>
  <%- include("partials/inFooter") %>
<% } %>
