<%- include('../partials/inHeader') -%>

<link rel="stylesheet" href="/css/pages/student-missions.css">

<main>
  <!-- Hero Header -->
  <div class="page-header">
    <h1 class="page-title">My Missions</h1>
    <div class="user-badge">
      <span><i class="fas fa-user-graduate"></i> <%= user.firstName %> <%= user.lastName %></span>
      <span><i class="fas fa-medal"></i> <%= user.rank %> Rank</span>
      <span><i class="fas fa-star"></i> <%= user.points %> Points</span>
    </div>
  </div>

  <!-- Rank Filter -->
  <div class="rank-filter">
    <button class="rank-btn active" data-rank="F">F Rank</button>
    <button class="rank-btn" data-rank="E">E Rank</button>
    <button class="rank-btn" data-rank="D">D Rank</button>
    <button class="rank-btn" data-rank="C">C Rank</button>
    <button class="rank-btn" data-rank="B">B Rank</button>
    <button class="rank-btn" data-rank="A">A Rank</button>
    <button class="rank-btn" data-rank="S">S Rank</button>
  </div>

  <!-- Available Missions -->
  <div class="missions-grid">
    <% missions.forEach(mission => { %>
      <div class="mission-card" data-rank="<%= mission.rank %>">
        <button class="select-mission"
          data-id="<%= mission._id %>"
          data-title="<%= mission.title %>"
          data-desc="<%= mission.description %>"
          data-type="<%= mission.type %>"
          data-cat="<%= mission.category %>"
          data-rank="<%= mission.rank %>"
          data-xp="<%= mission.pointsXP %>"
          data-time="<%= mission.timeLimit %>"
          data-creator="<%= mission.createdBy.name %>">
          Select Mission
        </button>
        <div class="mission-title"><%= mission.title %></div>
        <div class="mission-desc"><%= mission.description %></div>
        <div class="mission-tags">
          <span class="tag"><%= mission.type %></span>
          <span class="tag"><%= mission.category %></span>
          <span class="tag"><%= mission.rank %> Rank</span>
          <span class="tag">+<%= mission.pointsXP %> XP</span>
        </div>
        <small class="mission-byline">by <%= mission.createdBy.name %></small>
      </div>
    <% }) %>
  </div>

  <!-- Active Missions -->
  <h2 class="section-title"><i class="fas fa-running"></i> Active Missions</h2>
  <table class="missions-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Rank</th>
        <th>XP</th>
        <th>Due</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      <% if (activeMissions && activeMissions.length > 0) { %>
        <% activeMissions.forEach(mission => { %>
          <tr>
            <td><strong><%= mission.title %></strong></td>
            <td><%= mission.description %></td>
            <td><%= mission.rank %></td>
            <td>+<%= mission.pointsXP %> XP</td>
            <td><%= mission.dueDate ? mission.dueDate.toDateString() : "No limit" %></td>
            <td>
              <form method="POST" action="/student/missions/complete?_method=PUT" class="inline-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input type="hidden" name="missionId" value="<%= mission._id %>">
                <button type="submit" class="complete-btn">Complete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="6" class="table-empty table-empty-muted">No active missions â€” choose one above!</td></tr>
      <% } %>
    </tbody>
  </table>

  <!-- Leaderboard -->
  <h2 class="section-title"><i class="fas fa-trophy"></i> Top Students</h2>
  <table class="missions-table">
    <thead>
      <tr>
        <th>Position</th>
        <th>Student</th>
        <th>Rank</th>
        <th>Points</th>
      </tr>
    </thead>
    <tbody>
      <% if (students && students.length > 0) { %>
        <% students.forEach((student, i) => { %>
          <tr class="<%= student._id.toString() === user._id.toString() ? 'leader-me' : '' %>">
            <td><%= i + 1 %></td>
            <td><%= student.firstName %> <%= student.lastName %> <%= student._id.toString() === user._id.toString() ? '(You)' : '' %></td>
            <td><%= student.rank %></td>
            <td><%= student.points %></td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr><td colspan="4" class="table-empty">No students yet</td></tr>
      <% } %>
    </tbody>
  </table>
</main>

<!-- Modal -->
<div class="modal-overlay" id="missionModal">
  <div class="modal">
    <button class="close-btn" id="closeModal">X</button>
    <h2 id="modalTitle" class="modal-title"></h2>
    <p id="modalDescription" class="modal-description"></p>
    <div class="modal-meta">
      <p><strong>Type:</strong> <span id="modalType"></span></p>
      <p><strong>Category:</strong> <span id="modalCategory"></span></p>
      <p><strong>Rank:</strong> <span id="modalRank"></span></p>
      <p><strong>XP Reward:</strong> <span id="modalXP"></span></p>
      <p><strong>Time Limit:</strong> <span id="modalTime"></span></p>
      <p><strong>Created By:</strong> <span id="modalCreator"></span></p>
    </div>
    <form id="beginForm" method="POST" action="/student/missions/begin?_method=PUT">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
      <input type="hidden" name="missionId" id="beginMissionId">
      <button type="submit" class="begin-btn">Begin Mission</button>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById("missionModal");
  const closeModal = document.getElementById("closeModal");

  document.querySelectorAll('.select-mission').forEach(btn => {
    btn.addEventListener('click', () => {
      document.getElementById('modalTitle').textContent = btn.dataset.title;
      document.getElementById('modalDescription').textContent = btn.dataset.desc;
      document.getElementById('modalType').textContent = btn.dataset.type;
      document.getElementById('modalCategory').textContent = btn.dataset.cat;
      document.getElementById('modalRank').textContent = btn.dataset.rank;
      document.getElementById('modalXP').textContent = btn.dataset.xp;
      document.getElementById('modalTime').textContent = btn.dataset.time;
      document.getElementById('modalCreator').textContent = btn.dataset.creator;
      document.getElementById('beginMissionId').value = btn.dataset.id;
      modal.style.display = "flex";
    });
  });

  closeModal.onclick = () => modal.style.display = "none";
  window.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

  // Rank filtering
  document.querySelectorAll('.rank-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.rank-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const rank = btn.dataset.rank;
      document.querySelectorAll('.mission-card').forEach(card => {
        card.style.display = (rank === 'all' || card.dataset.rank === rank) ? 'block' : 'none';
      });
    });
  });
</script>

<%- include('../partials/inFooter') -%>
